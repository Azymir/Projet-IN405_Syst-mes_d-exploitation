#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "mes_types.h"
#include <math.h>
#include <fcntl.h>
#include <unistd.h>

int convString(int Fichier)
{				// convertir une chaine de caractere en entier
	char caractere = 0;

	int n = 0;

	while (read(Fichier, &caractere, 1) != 0
	       && (caractere != ';' && caractere != '\n')) {

		if ((caractere < '0') || (caractere > '9')) {
			perror
			    ("Votre fichier est incorecte. Verifier que vos donnes correspond à : [0 à 9] soit des entiers.\n");
			exit(0);
		}

		n = n * 10 + atoi(&caractere);

	}

	//printf("%d\n",n);

	return n;

}

int goLine(int Fichier, int i)
{

	char caractere = 0;
	for (int j = 0; j < i; j++) {

		while (caractere != '\n') {

			read(Fichier, &caractere, 1);

		}

		caractere = 0;

		//printf("fin du fichier");
	}

	return Fichier;

}

BANQUE readTMise(int Fichier, BANQUE B)
{

	char caractere = 0;
	int i = 0;
	for (int j = 0; j < 5; j++) {
		B.typeMise[j] = 0;
	}
	while (read(Fichier, &caractere, 1) != 0 && caractere != ';') {
		B.typeMise[i] = caractere;
		i++;
	}

	return B;
}

INIT lire_init(char *nom)
{
	INIT I;

	int Fichier = open(nom, O_RDONLY);	// on ouvre le fichier en lecture seule

	I.nbJoueurs = convString(Fichier);
	//printf("%d \n",I.nbJoueurs);

	I.nbDecks = convString(Fichier);
	//printf("%d \n",I.nbDecks);

	I.nbMains = convString(Fichier);
	//printf("%d \n",I.nbMains);

	if (I.nbJoueurs == 0 || I.nbDecks == 0 || I.nbMains == 0) {
		perror
		    ("Votre fichier est incorecte. Verifier que le format du fichier correspond à : [1 à 9];[1 à 9];[1 à 9] soit des entiers..\n");
		printf("Votre format est le suivant : %d;%d;%d\n", I.nbJoueurs,
		       I.nbDecks, I.nbMains);
		exit(0);
	}

	close(Fichier);		// fermeture du fichier   

	return I;

}

BANQUE lire_banque(char *nom, int i)
{

	BANQUE B;

	int Fichier = open(nom, O_RDONLY);
	//char caractere = 0;

	Fichier = goLine(Fichier, i + 2);

	B.nbJetons = convString(Fichier);
//      printf("%d \n",B.nbJetons);

	B = readTMise(Fichier, B);
	//printf("%s \n",B.typeMise);

	B.valStop = convString(Fichier);
	//printf("%d \n",B.valStop);

	B.objJetons = convString(Fichier);
	//printf("%d \n",B.objJetons);

	return B;

}
